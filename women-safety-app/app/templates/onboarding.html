<!-- Onboarding Overlay - Appears on every manual refresh -->
<div id="onboardingOverlay" class="onboarding-overlay" style="display:none;">
  <div class="onboarding-container">
    <!-- Step 1: Welcome -->
    <div class="onboarding-step active" data-step="1">
      <div class="onboarding-icon">üõ°Ô∏è</div>
      <h2 class="onboarding-title">Welcome to Gringotts</h2>
      <p class="onboarding-text">
        Your secure, anonymous platform for safety and support. 
        Let's set up a few permissions to help keep you safe.
      </p>
      <button class="btn-onboarding btn-onboarding-primary" onclick="nextOnboardingStep()">Get Started</button>
      <button class="btn-onboarding btn-onboarding-skip" onclick="skipOnboarding()">Skip for Now</button>
    </div>

    <!-- Step 2: Location Permission -->
    <div class="onboarding-step" data-step="2">
      <div class="onboarding-icon">üìç</div>
      <h2 class="onboarding-title">Location Access</h2>
      <p class="onboarding-text">
        Allows us to show nearby safe routes, emergency contacts, and quick SOS alerts with your location.
      </p>
      <button class="btn-onboarding btn-onboarding-primary" onclick="requestLocationPermission()">Allow Location</button>
      <button class="btn-onboarding btn-onboarding-skip" onclick="skipPermission('location')">Skip</button>
    </div>

    <!-- Step 3: Microphone Permission -->
    <div class="onboarding-step" data-step="3">
      <div class="onboarding-icon">üé§</div>
      <h2 class="onboarding-title">Microphone Access</h2>
      <p class="onboarding-text">
        Enables voice recording during emergencies and AI-powered voice interactions in fake calls.
      </p>
      <button class="btn-onboarding btn-onboarding-primary" onclick="requestMicPermission()">Allow Microphone</button>
      <button class="btn-onboarding btn-onboarding-skip" onclick="skipPermission('microphone')">Skip</button>
    </div>

    <!-- Step 4: Camera Permission -->
    <div class="onboarding-step" data-step="4">
      <div class="onboarding-icon">üì∑</div>
      <h2 class="onboarding-title">Camera Access</h2>
      <p class="onboarding-text">
        Lets you capture photo evidence for incident reports and profile photos.
      </p>
      <button class="btn-onboarding btn-onboarding-primary" onclick="requestCameraPermission()">Allow Camera</button>
      <button class="btn-onboarding btn-onboarding-skip" onclick="skipPermission('camera')">Skip</button>
    </div>

    <!-- Step 5: Notification Permission -->
    <div class="onboarding-step" data-step="5">
      <div class="onboarding-icon">üîî</div>
      <h2 class="onboarding-title">Notifications</h2>
      <p class="onboarding-text">
        Stay updated with safety alerts, emergency responses, and community support messages.
      </p>
      <button class="btn-onboarding btn-onboarding-primary" onclick="requestNotificationPermission()">Allow Notifications</button>
      <button class="btn-onboarding btn-onboarding-skip" onclick="skipPermission('notifications')">Skip</button>
    </div>

    <!-- Step 6: All Set -->
    <div class="onboarding-step" data-step="6">
      <div class="onboarding-icon">‚úÖ</div>
      <h2 class="onboarding-title">You're All Set!</h2>
      <p class="onboarding-text">
        Gringotts is ready to help keep you safe. Access all features from the dashboard.
      </p>
      <button class="btn-onboarding btn-onboarding-primary" onclick="finishOnboarding()">Enter Gringotts</button>
    </div>

    <!-- Progress indicator -->
    <div class="onboarding-progress">
      <div class="onboarding-progress-bar" id="onboardingProgressBar"></div>
    </div>
    <div class="onboarding-step-indicator" id="stepIndicator">Step 1 of 6</div>
  </div>
</div>

<style>
.onboarding-overlay {
  position: fixed;
  inset: 0;
  z-index: 99999;
  background: linear-gradient(135deg, rgba(107,127,215,0.95) 0%, rgba(155,126,222,0.95) 100%);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.5s ease;
}

.onboarding-container {
  width: 90%;
  max-width: 480px;
  background: #fff;
  border-radius: 24px;
  padding: 48px 32px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  position: relative;
  overflow: hidden;
}

.onboarding-step {
  display: none;
  text-align: center;
  animation: slideIn 0.4s ease;
}

.onboarding-step.active {
  display: block;
}

.onboarding-icon {
  font-size: 80px;
  margin-bottom: 24px;
  animation: bounceIn 0.6s ease;
}

.onboarding-title {
  font-size: 28px;
  font-weight: 800;
  color: #1e293b;
  margin-bottom: 16px;
}

.onboarding-text {
  font-size: 16px;
  line-height: 1.6;
  color: #64748b;
  margin-bottom: 32px;
}

.btn-onboarding {
  width: 100%;
  padding: 16px;
  border-radius: 12px;
  border: none;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 12px;
}

.btn-onboarding-primary {
  background: linear-gradient(135deg, #6B7FD7 0%, #9B7EDE 100%);
  color: #fff;
}

.btn-onboarding-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(107,127,215,0.4);
}

.btn-onboarding-skip {
  background: transparent;
  color: #64748b;
  border: 2px solid #e2e8f0;
}

.btn-onboarding-skip:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
}

.onboarding-progress {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: #e2e8f0;
}

.onboarding-progress-bar {
  height: 100%;
  background: linear-gradient(135deg, #6B7FD7 0%, #9B7EDE 100%);
  transition: width 0.4s ease;
  width: 0%;
}

.onboarding-step-indicator {
  position: absolute;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  color: #94a3b8;
  font-weight: 600;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes bounceIn {
  0% { opacity: 0; transform: scale(0.3); }
  50% { transform: scale(1.05); }
  100% { opacity: 1; transform: scale(1); }
}
</style>

<script>
let currentOnboardingStep = 1;
const totalSteps = 6;
const permissionsGranted = {
  location: false,
  microphone: false,
  camera: false,
  notifications: false
};

// Show onboarding on every manual page refresh
window.addEventListener('DOMContentLoaded', function() {
  // Check if page was manually refreshed (not auto-reload from Flask debug)
  const perfEntries = performance.getEntriesByType('navigation');
  const isManualRefresh = perfEntries.length > 0 && perfEntries[0].type === 'reload';
  
  // Always show onboarding on manual refresh
  if (isManualRefresh || !sessionStorage.getItem('onboardingShownThisSession')) {
    document.getElementById('onboardingOverlay').style.display = 'flex';
    sessionStorage.setItem('onboardingShownThisSession', 'true');
  }
});

function nextOnboardingStep() {
  if (currentOnboardingStep < totalSteps) {
    document.querySelector('.onboarding-step.active').classList.remove('active');
    currentOnboardingStep++;
    document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`).classList.add('active');
    updateProgress();
  }
}

function updateProgress() {
  const progress = ((currentOnboardingStep - 1) / (totalSteps - 1)) * 100;
  document.getElementById('onboardingProgressBar').style.width = progress + '%';
  document.getElementById('stepIndicator').textContent = `Step ${currentOnboardingStep} of ${totalSteps}`;
}

function skipPermission(type) {
  console.log(`Skipped ${type} permission`);
  nextOnboardingStep();
}

function skipOnboarding() {
  document.getElementById('onboardingOverlay').style.display = 'none';
}

function finishOnboarding() {
  document.getElementById('onboardingOverlay').style.display = 'none';
  // Show success toast
  if (typeof showToast === 'function') {
    showToast('Welcome to Gringotts! üéâ');
  }
}

async function requestLocationPermission() {
  try {
    const permission = await navigator.permissions.query({ name: 'geolocation' });
    if (permission.state === 'granted' || permission.state === 'prompt') {
      navigator.geolocation.getCurrentPosition(
        () => {
          permissionsGranted.location = true;
          console.log('Location permission granted');
          nextOnboardingStep();
        },
        (error) => {
          console.log('Location permission denied:', error);
          nextOnboardingStep();
        }
      );
    } else {
      nextOnboardingStep();
    }
  } catch (e) {
    console.log('Location permission not supported');
    nextOnboardingStep();
  }
}

async function requestMicPermission() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    permissionsGranted.microphone = true;
    console.log('Microphone permission granted');
    stream.getTracks().forEach(track => track.stop());
    nextOnboardingStep();
  } catch (error) {
    console.log('Microphone permission denied:', error);
    nextOnboardingStep();
  }
}

async function requestCameraPermission() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    permissionsGranted.camera = true;
    console.log('Camera permission granted');
    stream.getTracks().forEach(track => track.stop());
    nextOnboardingStep();
  } catch (error) {
    console.log('Camera permission denied:', error);
    nextOnboardingStep();
  }
}

async function requestNotificationPermission() {
  try {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        permissionsGranted.notifications = true;
        console.log('Notification permission granted');
      }
    }
    nextOnboardingStep();
  } catch (error) {
    console.log('Notification permission denied:', error);
    nextOnboardingStep();
  }
}
</script>
